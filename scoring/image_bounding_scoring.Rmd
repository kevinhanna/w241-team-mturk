---
title: "Team mTurk - Image Bounding Scoring"
output: 
    github_document: default
    pdf_document: default
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile, encoding = encoding,
    output_format = c('github_document', 'pdf_document')) 
    })
  
---

```{r setup, include=FALSE}
library(data.table)
library(dplyr)
library(rjson)
#library(knitr)
```

```{r}
# Read the results from Mechanical Turk
mturk_results_dt <- fread("../data/sample_openimages_output1.csv")
head(mturk_results_dt)
```

```{r}
# Read in the correct bounding cooridinates
image_coords_dt <- fread("../data/image_coords.csv")
head(image_coords_dt)
```

```{r}
convert_mturk_bounding <- function(mturk_bounding_boxes) {
  # Mechanical Turk provides results with double-quoted JSON consisting of:
  #   height
  #   width
  #   top
  #   left
  #   label

  # Converts to top-left and bottom-right coords
  
  # Replace double-quotes (assumes there are no empty values)
  mturk_bounding_boxes <- gsub("\"\"", "\"", mturk_bounding_boxes)
  bounding_boxes_list <- fromJSON(mturk_bounding_boxes)
  
  if (length(bounding_boxes_list) < 1) {
    print("No rows")
    return(NULL)
  }
    
  top_results_list <- c()
  bottom_results_list <- c()
  right_results_list <- c()
  left_results_list <- c()
  
  for (bounding_box in bounding_boxes_list) {
    top = as.integer(bounding_box$top)
    left = as.integer(bounding_box$left)
    bottom = as.integer(top + bounding_box$height)
    right = as.integer(left + bounding_box$width)

    top_results_list <- c(top_results_list, top)
    bottom_results_list <- c(bottom_results_list, bottom)
    right_results_list <- c(right_results_list, right)
    left_results_list <- c(left_results_list, left)
  }


  ret_dt <- data.table(
    top = top_results_list,
    bottom = bottom_results_list,
    right = right_results_list,
    left = left_results_list
  )
    
  return(ret_dt)
}

extract_image_bounding_data <- function(dt) {
  # Iterate through data.table, separate bounding boxes in to new rows in case there are multiple bounding boxes in any images. 
  
  results_dt <- data.table()
  
  for (i in 1:nrow(dt)) {
    row <- dt[i, ]

    bounding_boxes_dt <- convert_mturk_bounding(row[, Answer.annotatedResult.boundingBoxes])
    
    if (is.null(bounding_boxes_dt)) {
      next
    }
    
    # Add attributes for the HIT to bounding boxes
    bounding_boxes_dt[, HITId := row[, HITId]]
    bounding_boxes_dt[, HITTypeId := row[, HITTypeId]]
    bounding_boxes_dt[, Reward := row[, Reward]]
    bounding_boxes_dt[, AssignmentDurationInSeconds := row[, AssignmentDurationInSeconds]]
    bounding_boxes_dt[, WorkerId := row[, WorkerId]]
    bounding_boxes_dt[, AssignmentStatus := row[, AssignmentStatus]]
    bounding_boxes_dt[, LifetimeApprovalRate := row[, LifetimeApprovalRate]]
    bounding_boxes_dt[, Last30DaysApprovalRate := row[, Last30DaysApprovalRate]]
    bounding_boxes_dt[, Last7DaysApprovalRate := row[, Last7DaysApprovalRate]]
    bounding_boxes_dt[, ImageId := row[, Input.image_url]] # Column renamed
    
    #bounding_boxes_dt[, bounding_box_score := -0.111]
    
    # Concatinate to results
    results_dt <- rbind(results_dt, bounding_boxes_dt)
  }
  
  return(results_dt)
}

score_bounding_box <- function(true_coords, turker_coords) {
  # Calculate the difference in the top-right and bottom-left points
  
  top = as.integer(true_coords[, top]) - turker_coords[, top]
  right = true_coords[, right] - turker_coords[, right]
  first_distance <- sqrt(top^2 + right^2)

  bottom = as.integer(true_coords[, bottom]) - turker_coords[, bottom]
  left = true_coords[, left] - turker_coords[, left]
  second_distance <- sqrt(bottom^2 + left^2)
  
  return(first_distance + second_distance)
  
}





```

```{r}
# Prepare the mturk results
image_boundings_dt <- extract_image_bounding_data(mturk_results_dt)

score_mturk_results <- function() {
  scoring_results = c()
  # Iterate through the correct bounding boxes and score the results
  for (i in 1:nrow(image_coords_dt)) {
    row <- image_coords_dt[i, ]
    tmp_scoring_results = c()
  
    matched_images_dt <- image_boundings_dt[ImageId == row[, ImageId], ]
  
    if (nrow(matched_images_dt) > 1) {
      #cat("Too many matched images for: (", nrow(matched_images_dt), ")", print(row[, ImageId]))
    }

    # In case there are multiple bounding boxes, we'll grab the best score
    for (i in 1:nrow(matched_images_dt)) {
      bounding_box_score <- score_bounding_box(row[, ], matched_images_dt[, ])
      tmp_scoring_results <- c(tmp_scoring_results, bounding_box_score)
    }
    scoring_results <- c(scoring_results, min(tmp_scoring_results))
  }
  scoring_results
}

mturk_results_dt[, bounding_box_score := score_mturk_results()]

print(mturk_results_dt[, c("HITId", "bounding_box_score")])


```


